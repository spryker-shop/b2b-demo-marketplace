{% extends '@Gui/Layout/layout.twig' %}

{% set widget_title = 'Tenant Assigner' %}

{% block head_title widget_title %}
{% block section_title widget_title %}

{% block content %}

    {% embed '@Gui/Partials/widget.twig' %}

        {% block widget_content %}

            <div class="row">
                <div class="col-lg-12">
                    <div class="ibox">
                        <div class="ibox-title">
                            <h5>Tables with Tenant Support</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            
                            {% if tables is empty %}
                                <div class="alert alert-info">
                                    <strong>No tables found</strong> with tenant support (id_tenant column).
                                    <br>Make sure you have applied the TenantBehavior to your Propel schemas.
                                </div>
                            {% else %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered table-hover dataTables-example">
                                        <thead>
                                            <tr>
                                                <th>Table Name</th>
                                                <th>Display Name</th>
                                                <th>Total Rows</th>
                                                <th>With Tenant</th>
                                                <th>Unassigned</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for table in tables %}
                                                <tr>
                                                    <td><code>{{ table.tableName }}</code></td>
                                                    <td>{{ table.displayName }}</td>
                                                    <td>
                                                        <span class="label label-primary">{{ table.rowCount }}</span>
                                                    </td>
                                                    <td>
                                                        <span class="label label-success">{{ table.tenantRowCount }}</span>
                                                    </td>
                                                    <td>
                                                        {% if table.unassignedRowCount > 0 %}
                                                            <span class="label label-warning">{{ table.unassignedRowCount }}</span>
                                                        {% else %}
                                                            <span class="label label-info">{{ table.unassignedRowCount }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <a href="{{ url('/tenant-assigner/index/table', {'name': table.tableName}) }}" 
                                                           class="btn btn-sm btn-primary">
                                                            <i class="fa fa-tasks"></i> Assign Tenant
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>

        {% endblock %}

    {% endembed %}

{% endblock %}

{% block footer_js %}
    {{ parent() }}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize DataTable if available
            var table = document.querySelector('.dataTables-example');
            if (table && typeof DataTable !== 'undefined') {
                new DataTable('.dataTables-example', {
                    pageLength: 25,
                    responsive: true,
                    dom: '<"html5buttons"B>lTfgitp',
                    buttons: [
                        {extend: 'copy'},
                        {extend: 'csv'},
                        {extend: 'excel', title: 'Tables with Tenant Support'},
                        {extend: 'pdf', title: 'Tables with Tenant Support'},
                        {extend: 'print',
                         customize: function (win){
                                win.document.body.classList.add('white-bg');
                                win.document.body.style.fontSize = '10px';
                                var tables = win.document.body.querySelectorAll('table');
                                tables.forEach(function(table) {
                                    table.classList.add('compact');
                                    table.style.fontSize = 'inherit';
                                });
                        }
                        }
                    ]
                });
            }
        });
    </script>

{% endblock %}
